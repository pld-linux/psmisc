--- psmisc-21.3/doc/killall.1.selinux	2003-05-23 08:04:22.000000000 -0400
+++ psmisc-21.3/doc/killall.1	2003-08-28 14:01:12.000000000 -0400
@@ -4,7 +4,6 @@
 .SH SYNOPSIS
 .ad l
 .B killall
-.RB [ \-d , \-\-sid ]
 .RB [ \-c , \-\-context ] 
 .RB [ \-e , --exact ]
 .RB [ \-g , \-\-process-group ]
@@ -67,12 +66,9 @@
 any of the killed processes still exist and only returns if none are left.
 Note that \fBkillall\fP may wait forever if the signal was ignored, had no
 effect, or if the process stays in zombie state.
-.IP \fB\-d\fP
-(Flask only) Specify SID: kill only processes with given SID. Mutually exclusive
-with \fB-c\fP argument.  Must precede other arguments on command line.
-.IP \fB\-c\fP
-(Flask only) Specify security context: kill only processes with given security context.
-Mutually exclusive with \fB-d\fP.  Must precede other arguments on the command line.
+.IP \fB\-Z\fP
+(SELinux Only) Specify security context: kill only processes with given security context.
+Must precede other arguments on the command line.
 .SH FILES
 .nf
 /proc	location of the proc file system
--- psmisc-21.5/doc/pstree.1.orig	2004-04-24 14:44:27.000000000 +0200
+++ psmisc-21.5/doc/pstree.1	2004-07-16 07:50:24.316589960 +0200
@@ -12,6 +12,7 @@
 .RB [ \-p ]
 .RB [ \-u ]
 .RB [ \-A | \-G | \-U ]
+.RB [ \-Z ]
 .RB [ \fIpid\fB | \fIuser\fB]
 .br
 .B pstree
@@ -81,10 +82,8 @@
 with \fBecho -e '\\033%@'\fP
 .IP \fB\-V\fP
 Display version information.
-.IP \fB\-s\fP
-(Flask) Show Security ID (SID) for each process.
-.IP \fB\-x\fP
-(Flask) Show security context for each process.
+.IP \fB\-Z\fP
+(SELinux) Show security context for each process.
 .SH FILES
 .nf
 /proc	location of the proc file system
--- psmisc-21.5/src/killall.c.orig	2004-07-16 07:49:07.227309312 +0200
+++ psmisc-21.5/src/killall.c	2004-07-16 07:58:59.775228336 +0200
@@ -21,10 +21,11 @@
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <getopt.h>
-#ifdef FLASK_LINUX
-#include <selinux/fs_secure.h>
-#include <selinux/ss.h>
-#endif /*FLASK_LINUX*/
+
+#ifdef WITH_SELINUX
+#include <selinux/selinux.h>
+#endif /*WITH_SELINUX*/
+
 #ifdef ENABLE_NLS
 #include <libintl.h>
 #include <locale.h>
@@ -68,13 +69,13 @@
   return ch == 'y' || ch == 'Y';
 }
 
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
 static int
-kill_all(int signal, int names, char **namelist, security_id_t sid )
-#else  /*FLASK_LINUX*/
+kill_all(int signal, int names, char **namelist, security_context_t scontext )
+#else  /*WITH_SELINUX*/
 static int
 kill_all (int signal, int names, char **namelist)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 {
   DIR *dir;
   struct dirent *de;
@@ -89,11 +90,11 @@
   int empty, i, j, okay, length, got_long, error;
   int pids, max_pids, pids_killed;
   unsigned long found;
-#ifdef FLASK_LINUX
-  security_id_t lsid;
+#ifdef WITH_SELINUX
+  security_context_t lcontext=NULL;
 
   if ( names == 0 || ! namelist ) exit( 1 ); /* do the obvious thing...*/
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 
   if (!(name_len = malloc (sizeof (int) * names)))
     {
@@ -106,19 +107,14 @@
 	sts[i].st_dev = 0;
 	name_len[i] = strlen (namelist[i]);
       }
-#ifdef FLASK_LINUX
-      else if (stat_secure(namelist[i],&sts[i], &lsid) < 0) {
-              perror(namelist[i]);
-              exit(1);
-          }
-#else  /*FLASK_LINUX*/
-    else if (stat (namelist[i], &sts[i]) < 0)
-      {
-	perror (namelist[i]);
-	exit (1);
-      }
-#endif /*FLASK_LINUX*/
-   } 
+    else {
+      if (stat (namelist[i], &sts[i]) < 0)
+	{
+	  perror (namelist[i]);
+	  exit (1);
+	}
+    }
+  } 
   self = getpid ();
   found = 0;
   if (!(dir = opendir (PROC_BASE)))
@@ -268,37 +264,39 @@
 	      else if (got_long ? strcmp (namelist[j], command) :
 		       strncmp (namelist[j], comm, COMM_LEN - 1))
 		continue;
-#ifdef FLASK_LINUX
-              if ( (int) sid > 0 ) {
-                if ( stat_secure(path, &st, &lsid) < 0 )
+#ifdef WITH_SELINUX
+              if ( scontext != NULL ) {
+                if ( getpidcon(pid_table[i], &lcontext) < 0 )
                   continue;
-                if ( lsid != sid )
+                if (strcmp(lcontext,scontext)!=0) {
+		  freecon(lcontext);
                   continue;
+		}
+		freecon(lcontext);
               }
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 	    }
 	  else
 	    {
 	      if (asprintf (&path, PROC_BASE "/%d/exe", pid_table[i]) < 0)
 		continue;
-#ifdef FLASK_LINUX
-          if (stat_secure(path,&st,&lsid) < 0) {
-            free(path);
-            continue;
-          }
-          if (sts[j].st_dev != st.st_dev ||
-              sts[j].st_ino != st.st_ino ||
-              ((int) sid > 0 && (lsid != sid)) ) {
-            free(path);
-            continue;
-          }
-#else  /*FLASK_LINUX*/
+
 	      if (stat (path, &st) < 0) {
 		    free (path);
 		    continue;
 	      }
-#endif /*FLASK_LINUX*/
 	      free (path);
+#ifdef WITH_SELINUX
+              if ( scontext != NULL ) {
+                if ( getpidcon(pid_table[i], &lcontext) < 0 )
+                  continue;
+                if (strcmp(lcontext,scontext)!=0) {
+		  freecon(lcontext);
+                  continue;
+		}
+		freecon(lcontext);
+              }
+#endif /*WITH_SELINUX*/
 
 	      if (sts[j].st_dev != st.st_dev || sts[j].st_ino != st.st_ino)
 		continue;
@@ -395,13 +393,16 @@
 static void
 usage_killall (void)
 {
-#ifdef FLASK_LINUX
-  fprintf(stderr,_("Usage: killall [-s sid] [-c context] [ -egiqvw ] [ -signal ] name ...\n"));
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  fprintf(stderr,_("Usage: killall [-Z context] [ -egiqvw ] [ -signal ] name ...\n"));
+#else  /*WITH_SELINUX*/
   fprintf (stderr, _("usage: killall [ OPTIONS ] [ -- ] name ...\n"));
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
   fprintf (stderr, _("       killall -l, --list\n"));
   fprintf (stderr, _("       killall -V --version\n\n"));
+#ifdef WITH_SELINUX
+  fprintf (stderr, _("  -Z,--context        kill only process(es) having scontext\n"));
+#endif /*WITH_SELINUX*/
   fprintf (stderr, _("  -e,--exact          require exact match for very long names\n"));
   fprintf (stderr, _("  -I,--ignore-case-   case insensitive process name match\n"));
   fprintf (stderr, _("  -g,--process-group  kill process group instead of process\n"));
@@ -412,11 +413,6 @@
   fprintf (stderr, _("  -v,--verbose        report if the signal was successfully sent\n"));
   fprintf (stderr, _("  -V,--version        display version information\n"));
   fprintf (stderr, _("  -w,--wait           wait for processes to die\n\n"));
-#ifdef FLASK_LINUX
-  fprintf (stderr, _("  -d,--sid            kill only process(es) having sid\n"));
-  fprintf (stderr, _("  -c,--context        kill only process(es) having scontext\n"));
-  fprintf(stderr, _("   (-s, -c are mutually exclusive and must precede other arguments)\n\n"));
-#endif /*FLASK_LINUX*/
 }
 
 
@@ -459,18 +455,17 @@
     {"signal", 1, NULL, 's'},
     {"verbose", 0, NULL, 'v'},
     {"wait", 0, NULL, 'w'},
-#ifdef FLASK_LINUX
-    {"Sid", 1, NULL, 'd'},
+#ifdef WITH_SELINUX
     {"context", 1, NULL, 'c'},
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
     {"version", 0, NULL, 'V'},
     {0,0,0,0 }};
 
-#ifdef FLASK_LINUX
-  security_id_t sid = -1;
+#ifdef WITH_SELINUX
+  security_context_t scontext = NULL;
 
   if ( argc < 2 ) usage(); /* do the obvious thing... */
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 
   name = strrchr (*argv, '/');
   if (name)
@@ -488,8 +483,8 @@
 #endif
 
   opterr = 0;
-#ifdef FLASK_LINUX
-  while ( (optc = getopt_long_only(argc,argv,"egilqs:vwd:c:VI",options,NULL)) != EOF) {
+#ifdef WITH_SELINUX
+  while ( (optc = getopt_long_only(argc,argv,"egilqs:vwZ:VI",options,NULL)) != EOF) {
 #else
   while ( (optc = getopt_long_only(argc,argv,"egilqs:vwVI",options,NULL)) != EOF) {
 #endif
@@ -536,48 +531,14 @@
         print_version();
         return 0;
         break;
-#ifdef FLASK_LINUX
-      case 'd': {
-          char **buf, *calloc();
-          int strlen(), rv;
-          __u32 len;
-          security_id_t lsid;
-
-          buf = (char **) calloc(1, strlen(optarg));
-          if ( ! buf ) {
-             (void) fprintf(stderr, "%s: %s\n", name, strerror(errno));
-             return( 1 );
-          }
-
-	  lsid = strtol(optarg, buf, 0);
-          if ( **buf ) {
-              (void) fprintf(stderr, _("%s: SID (%s) must be numeric\n"), name, *argv);
-              (void) fflush(stderr);
-              return( 1 );
-          }
-
-          sid = (security_id_t) lsid;
-          /* sanity check */
-          len = strlen(optarg);
-          rv = security_sid_to_context(sid, buf, &len);
-          if ( rv < 0 && (errno != ENOSPC) ) {
-              (void) fprintf(stderr, "%s: security_sid_to_context(%d) %s\n", name, (int) sid, strerror(errno));
-              (void) fflush(stderr);
-              free(buf);
-              return( 1 );
-          }
-          free(buf);
-          break;
-      }
-      case 'c': {
-          if ( security_context_to_sid(optarg, strlen(optarg)+1, &sid) ) {
-              (void) fprintf(stderr, "%s: security_context_to_sid(%s): %s\n",
-                     name, optarg, strerror(errno));
-              (void) fflush(stderr);
-              return( 1 );
-          }
-      }
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+	case 'Z': 
+	  if( is_selinux_enabled() > 0)
+	    scontext=optarg;
+	  else 
+	    fprintf(stderr, _("Warning: -Z (--context) ignored. Requires an SELinux enabled kernel\n"));
+	  break;
+#endif /*WITH_SELINUX*/
       case '?':
         /* Signal names are in uppercase, so check to see if the argv
          * is upper case */
@@ -609,9 +570,9 @@
     }
   argv = argv + myoptind;
   /*printf("sending signal %d to procs\n", sig_num);*/
-#ifdef FLASK_LINUX
-  return kill_all(sig_num,argc - myoptind, argv, sid);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  return kill_all(sig_num,argc - myoptind, argv, scontext);
+#else  /*WITH_SELINUX*/
   return kill_all(sig_num,argc - myoptind, argv );
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 }
--- psmisc-21.4/src/Makefile.am.orig	2003-11-28 12:22:16.000000000 +0100
+++ psmisc-21.4/src/Makefile.am	2003-12-11 00:27:12.834735104 +0100
@@ -9,11 +9,11 @@
 
 killall_SOURCES = killall.c comm.h signals.c signals.h signames.h
 
-killall_LDADD = @FLASK_LIB@
+killall_LDADD = @SELINUX_LIB@
 
 pstree_SOURCES = pstree.c comm.h
 
-pstree_LDADD = @TERMCAP_LIB@ @FLASK_LIB@
+pstree_LDADD = @TERMCAP_LIB@ @SELINUX_LIB@
 
 BUILT_SOURCES = signames.h
 
--- psmisc-21.5/src/pstree.c.orig	2004-07-16 07:49:07.232308552 +0200
+++ psmisc-21.5/src/pstree.c	2004-07-16 07:59:51.907303056 +0200
@@ -33,9 +33,9 @@
 
 #include "comm.h"
 
-#ifdef FLASK_LINUX
-#include <fs_secure.h>
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+#include <selinux/selinux.h>
+#endif /*WITH_SELINUX*/
 
 #ifndef MAX_DEPTH
 #define MAX_DEPTH    100
@@ -64,9 +64,9 @@
   int argc;			/* with -a   : number of arguments, -1 if swapped    */
   pid_t pid;
   uid_t uid;
-#ifdef FLASK_LINUX
-  security_id_t sid;
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  security_context_t scontext;
+#endif /*WITH_SELINUX*/
   int highlight;
   struct _child *children;
   struct _proc *parent;
@@ -114,10 +114,9 @@
 static int width[MAX_DEPTH], more[MAX_DEPTH];
 static int print_args = 0, compact = 1, user_change = 0, pids = 0, by_pid = 0,
   trunc = 1, wait_end = 0;
-#ifdef FLASK_LINUX
-static int show_sids    = 0;
+#ifdef WITH_SELINUX
 static int show_scontext = 0;
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 static int output_width = 132;
 static int cur_x = 1;
 static char last_char = 0;
@@ -167,38 +166,16 @@
   return digits;
 }
 
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
 static void 
-out_sid ( security_id_t sid )
+out_scontext ( security_context_t scontext )
 {
-  if ( (int) sid >= 0 )
-    out_int((int) sid);
-  else
-    out_string("??");
-}
-
-static void 
-out_scontext ( security_id_t sid )
-{
-  static char buf[256];
-  int security_sid_to_context();
-  int len = sizeof(buf);
-  int rv;
-
-  bzero(buf,256);
-
-  rv = security_sid_to_context((int)sid, buf, &len);
-  if ( rv ) {
-    out_string("`??\'"); /* punt */
-  }
-  else {
     out_string("`");
-    out_string(buf);
-    out_string("\'");
-  }
+    out_string(scontext);
+    out_string("'");
 }
-#endif /*FLASK_LINUX*/
-
+#endif /*WITH_SELINUX*/
+  
 
 static void
 out_newline (void)
@@ -222,13 +199,13 @@
   return walk;
 }
 
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
 static PROC *
-new_proc(const char *comm, pid_t pid, uid_t uid, security_id_t sid)
-#else  /*FLASK_LINUX*/
+new_proc(const char *comm, pid_t pid, uid_t uid, security_context_t scontext)
+#else  /*WITH_SELINUX*/
 static PROC *
 new_proc (const char *comm, pid_t pid, uid_t uid)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 {
   PROC *new;
 
@@ -241,9 +218,9 @@
   new->pid = pid;
   new->uid = uid;
   new->highlight = 0;
-#ifdef FLASK_LINUX
-  new->sid = sid;
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  new->scontext = scontext;
+#endif /*WITH_SELINUX*/
   new->children = NULL;
   new->parent = NULL;
   new->next = list;
@@ -312,24 +289,24 @@
     this->argv[i] = start = strchr (start, 0) + 1;
 }
 
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
 static void
 add_proc(const char *comm, pid_t pid, pid_t ppid, uid_t uid,
-         const char *args, int size, security_id_t sid)
-#else  /*FLASK_LINUX*/
+         const char *args, int size, security_context_t scontext)
+#else  /*WITH_SELINUX*/
 static void
 add_proc (const char *comm, pid_t pid, pid_t ppid, uid_t uid,
 	  const char *args, int size)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 {
   PROC *this, *parent;
 
   if (!(this = find_proc (pid)))
-#ifdef FLASK_LINUX
-    this = new_proc(comm, pid, uid, sid);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+    this = new_proc(comm, pid, uid, scontext);
+#else  /*WITH_SELINUX*/
     this = new_proc (comm, pid, uid);
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
   else
     {
       strcpy (this->comm, comm);
@@ -340,11 +317,11 @@
   if (pid == ppid)
     ppid = 0;
   if (!(parent = find_proc (ppid)))
-#ifdef FLASK_LINUX
-    parent = new_proc("?", ppid, 0, sid);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+    parent = new_proc("?", ppid, 0, scontext);
+#else  /*WITH_SELINUX*/
     parent = new_proc ("?", ppid, 0);
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
   add_child (parent, this);
   this->parent = parent;
 }
@@ -436,25 +413,17 @@
       else
 	(void) out_int (current->uid);
     }
-#ifdef FLASK_LINUX
-  if ( show_sids ) {
-    out_char (info++ ? ',' : '(');
-    out_sid(current->sid);
-  }
+#ifdef WITH_SELINUX
   if ( show_scontext ) {
     out_char (info++ ? ',' : '(');
-    out_scontext(current->sid);
+    out_scontext(current->scontext);
   }
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
   if ((swapped && print_args && current->argc < 0) || (!swapped && info))
     out_char (')');
   if (current->highlight && (tmp = tgetstr ("me", NULL)))
     tputs (tmp, 1, putchar);
-#ifdef FLASK_LINUX
-  if (show_scontext || print_args)
-#else  /*FLASK_LINUX*/
   if (print_args)
-#endif /*FLASK_LINUX*/
     {
       for (i = 0; i < current->argc; i++)
 	{
@@ -479,20 +448,20 @@
 	    }
 	}
     }
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
   if ( show_scontext || print_args || ! current->children )
-#else  /*FLASK_LINUX*/
+#else  /*WITH_SELINUX*/
   if (print_args || !current->children)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
     {
       while (closing--)
 	out_char (']');
       out_newline ();
-#ifdef FLASK_LINUX
+#ifdef WITH_SELINUX
       if ( show_scontext || print_args )
-#else /*FLASK_LINUX*/
+#else /*WITH_SELINUX*/
       if (print_args)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 	{
 	  more[level] = !last;
 	  width[level] = swapped + (comm_len > 1 ? 0 : -1);
@@ -582,9 +551,10 @@
   pid_t pid, ppid;
   int fd, size;
   int empty;
-#ifdef FLASK_LINUX
-  security_id_t sid = -1;
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  security_context_t scontext = NULL;
+  int selinux_enabled=(is_selinux_enabled() > 0);
+#endif /*WITH_SELINUX*/
 
   if (!print_args)
     buffer = NULL;
@@ -609,11 +579,15 @@
 	  {
 	    empty = 0;
 	    sprintf (path, "%s/%d", PROC_BASE, pid);
-#ifdef FLASK_LINUX
-            if (fstat_secure(fileno(file),&st,&sid) < 0)
-#else /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+	    if (selinux_enabled)
+	      if (getpidcon(pid,&scontext) < 0)
+		{
+		  perror (path);
+		  exit (1);
+		}
+#endif /*WITH_SELINUX*/
             if (stat (path, &st) < 0)
-#endif /*FLASK_LINUX*/
 	    {
 		perror (path);
 		exit (1);
@@ -638,11 +612,11 @@
 		 &ppid) == 4)
  */
 		if (!print_args)
-#ifdef FLASK_LINUX
-		  add_proc(comm, pid, ppid, st.st_uid, NULL, 0, sid);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+		  add_proc(comm, pid, ppid, st.st_uid, NULL, 0, scontext);
+#else  /*WITH_SELINUX*/
 		  add_proc (comm, pid, ppid, st.st_uid, NULL, 0);
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 		else
 		  {
 		    sprintf (path, "%s/%d/cmdline", PROC_BASE, pid);
@@ -659,11 +633,11 @@
 		    (void) close (fd);
 		    if (size)
 		      buffer[size++] = 0;
-#ifdef FLASK_LINUX
-		    add_proc(comm, pid, ppid, st.st_uid, buffer, size, sid);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+		    add_proc(comm, pid, ppid, st.st_uid, buffer, size, scontext);
+#else  /*WITH_SELINUX*/
 		    add_proc (comm, pid, ppid, st.st_uid, buffer, size);
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
 		  }
 		}
 	      }
@@ -702,11 +676,11 @@
 	cmd = comm;
       if (*cmd == '-')
 	cmd++;
-#ifdef FLASK_LINUX
-      add_proc(cmd, pid, ppid, uid, NULL, 0, -1);
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+      add_proc(cmd, pid, ppid, uid, NULL, 0, NULL);
+#else  /*WITH_SELINUX*/
       add_proc (cmd, pid, ppid, uid, NULL, 0);
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
     }
 }
 
@@ -729,10 +703,9 @@
   fprintf (stderr, _("    -n     sort output by PID\n"));
   fprintf (stderr, _("    -p     show PIDs; implies -c\n"));
   fprintf (stderr, _("    -u     show uid transitions\n"));
-#ifdef FLASK_LINUX
-  fprintf (stderr, _("    -s     show Flask SIDs\n"));
-  fprintf (stderr, _("    -x     show Flask security contexts\n"));
-#endif /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  fprintf (stderr, _("    -Z     show SELinux security contexts\n"));
+#endif /*WITH_SELINUX*/
   fprintf (stderr, _("    -U     use UTF-8 (Unicode) line drawing characters\n"));
   fprintf (stderr, _("    -V     display version information\n"));
   fprintf (stderr, _("    pid    start at pid, default 1 (init)\n"));
@@ -802,11 +775,11 @@
     sym = &sym_ascii;
   }
 
-#ifdef FLASK_LINUX
-  while ((c = getopt (argc, argv, "aAcGhH:npluUVsx")) != EOF)
-#else  /*FLASK_LINUX*/
+#ifdef WITH_SELINUX
+  while ((c = getopt (argc, argv, "aAcGhH:npluUVZ")) != EOF)
+#else  /*WITH_SELINUX*/
   while ((c = getopt (argc, argv, "aAcGhH:npluUV")) != EOF)
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
     switch (c)
       {
       case 'a':
@@ -862,14 +835,14 @@
       case 'V':
       print_version();
 	return 0;
-#ifdef FLASK_LINUX
-      case 's':
-        show_sids = 1;
-        break;
-      case 'x':
-        show_scontext = 1;
+#ifdef WITH_SELINUX
+      case 'Z':
+	if (is_selinux_enabled() > 0)
+	  show_scontext = 1;
+	else
+	  fprintf(stderr, _("Warning: -Z ignored. Requires an SELinux enabled kernel\n"));
         break;
-#endif /*FLASK_LINUX*/
+#endif /*WITH_SELINUX*/
       default:
 	usage ();
       }
--- psmisc-21.3/configure.in.selinux	2003-05-28 19:45:24.000000000 -0400
+++ psmisc-21.3/configure.in	2003-08-28 14:00:20.000000000 -0400
@@ -9,14 +9,14 @@
 AM_PROG_LIBTOOL
 
 dnl checks for options
-AC_SUBST(FLASK_LINUX)
-AC_ARG_ENABLE(flask,[  --enable-flask  Enable Security-Enhanced Linux features],
-	AC_DEFINE([FLASK_LINUX],1,[Use Security-Enhanced Linux features])
-	AC_CHECK_LIB(secure, avc_toggle, FLASK_LIB=-lsecure,
-	   AC_MSG_ERROR(Cannot find selinux/ secure static library)
+AC_SUBST(WITH_SELINUX)
+AC_ARG_ENABLE(selinux,[  --enable-selinux  Enable Security-Enhanced Linux features],
+	AC_DEFINE([WITH_SELINUX],1,[Use Security-Enhanced Linux features])
+	AC_CHECK_LIB(selinux,getfilecon, SELINUX_LIB=-lselinux,
+	   AC_MSG_ERROR(Cannot find selinux secure static library)
 	)
 ,)
-AC_SUBST(FLASK_LIB)
+AC_SUBST(SELINUX_LIB)
 
 dnl Checks for libraries.
 AC_CHECK_LIB(ncurses, tgetent, TERMCAP_LIB=-lncurses,
--- psmisc-21.5/po/pl.po.orig	2004-07-16 19:28:31.239809728 +0200
+++ psmisc-21.5/po/pl.po	2004-07-16 20:06:27.193812128 +0200
@@ -79,8 +79,8 @@
 
 #: src/killall.c:399
 #, c-format
-msgid "Usage: killall [-s sid] [-c context] [ -egiqvw ] [ -signal ] name ...\n"
-msgstr "Sk³adnia: killall [-s sid] [-c kontekst] [ -egiqvw ] [ -sygna³ ] nazwa ...\n"
+msgid "Usage: killall [-Z context] [ -egiqvw ] [ -signal ] name ...\n"
+msgstr "Sk³adnia: killall [-Z kontekst] [ -egiqvw ] [ -sygna³ ] nazwa ...\n"
 
 #: src/killall.c:401
 #, c-format
@@ -101,6 +101,11 @@
 "       killall -V --version\n"
 "\n"
 
+#: src/killall.c:404
+#, c-format
+msgid "  -Z,--context        kill only process(es) having scontext\n"
+msgstr "  -Z,--context        zabicie tylko procesu(ów) maj±cych dany kontekst bezp.\n"
+
 #: src/killall.c:405
 #, c-format
 msgid "  -e,--exact          require exact match for very long names\n"
@@ -155,25 +160,6 @@
 "  -w,--wait           zaczekanie na ¶mieræ procesu\n"
 "\n"
 
-#: src/killall.c:416
-#, c-format
-msgid "  -d,--sid            kill only process(es) having sid\n"
-msgstr "  -d,--sid            zabicie tylko procesu(ów) maj±cych dany sid\n"
-
-#: src/killall.c:417
-#, c-format
-msgid "  -c,--context        kill only process(es) having scontext\n"
-msgstr "  -c,--context        zabicie tylko procesu(ów) maj±cych dany kontekst bezp.\n"
-
-#: src/killall.c:418
-#, c-format
-msgid ""
-"   (-s, -c are mutually exclusive and must precede other arguments)\n"
-"\n"
-msgstr ""
-"   (-s i -c wzajemnie siê wykluczaj± i musz± poprzedzaæ inne argumenty)\n"
-"\n"
-
 #: src/killall.c:436 src/pstree.c:746
 #, c-format
 msgid ""
@@ -203,10 +189,10 @@
 msgid "For more information about these matters, see the files named COPYING.\n"
 msgstr "Wiêcej informacji znajduje siê w pliku o nazwie COPYING.\n"
 
-#: src/killall.c:554
+#: src/killall.c:539
 #, c-format
-msgid "%s: SID (%s) must be numeric\n"
-msgstr "%s: SID (%s) musi byæ liczb±\n"
+msgid "Warning: -Z (--context) ignored. Requires an SELinux enabled kernel\n"
+msgstr "Uwaga: -Z (--context) zignorowane. Ta opcja wymaga j±dra z w³±czonym SELinuksem\n"
 
 #: src/killall.c:607
 #, c-format
@@ -436,15 +422,10 @@
 msgid "    -u     show uid transitions\n"
 msgstr "    -u     wy¶wietlanie zmian uidów\n"
 
-#: src/pstree.c:733
+#: src/pstree.c:707
 #, c-format
-msgid "    -s     show Flask SIDs\n"
-msgstr "    -s     wy¶wietlanie SID-ów Flask\n"
-
-#: src/pstree.c:734
-#, c-format
-msgid "    -x     show Flask security contexts\n"
-msgstr "    -x     wy¶wietlanie kontekstów bezpieczeñstwa Flask\n"
+msgid "    -Z     show SELinux security contexts\n"
+msgstr "    -Z     wy¶wietlanie kontekstów bezpieczeñstwa SELinuksa\n"
 
 #: src/pstree.c:736
 #, c-format
@@ -490,6 +471,11 @@
 msgid "Can't get terminal capabilities\n"
 msgstr "Nie mo¿na odczytaæ mo¿liwo¶ci terminala\n"
 
+#: src/pstree.c:843
+#, c-format
+msgid "Warning: -Z ignored. Requires an SELinux enabled kernel\n"
+msgstr "Uwaga: -Z zignorowane. Ta opcja wymaga j±dra z w³±czonym SELinuksem\n"
+
 #: src/pstree.c:884
 #, c-format
 msgid "No such user name: %s\n"
